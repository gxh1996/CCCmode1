const Fs=require("fire-fs"),Path=require("fire-path");Editor.require("packages://cc-inspector/plugin/CCInspectorPluginMsg.js");const CCInspectorPluginMsg=window.CCInspectorPluginMsg,PluginMsg=Editor.require("packages://cc-inspector/core/PluginMsg.js");Editor.require("packages://cc-inspector/panel/item.js")();const GoogleAnalytics=Editor.require("packages://cc-inspector/core/GoogleAnalytics.js");Editor.Panel.extend({style:Fs.readFileSync(Editor.url("packages://cc-inspector/panel/index.css"),"utf-8"),template:Fs.readFileSync(Editor.url("packages://cc-inspector/panel/index.html"),"utf-8"),ready(){GoogleAnalytics.init(),GoogleAnalytics.eventCustom("[main] panel-open-main");Editor.require("packages://cc-inspector/core/MtaH5.js");this.plugin=new window.Vue({el:this.shadowRoot,created(){this.treeData=[],this.onLaunchDebugServer();const e=Editor.require("packages://cc-inspector/core/PluginMsg.js");this.$root.$on(e.MsgInside.GetNodeInfo,e=>{e&&e.uuid&&this.webSocket.send(JSON.stringify({code:CCInspectorPluginMsg.Msg.GetNodeInfo,data:e.uuid}))})},data:{test:"",webSocket:null,treeData:[{name:"test1",folded:!1,position:cc.v2(100,100),anchor:cc.v2(0,0),size:cc.size(200,200),rotation:0,opacity:255,color:{r:200,g:100,b:34,a:255},skew:cc.v2(3,3),children:[{name:"children1",folded:!1,children:[{name:"children66",folded:!1},{name:"children66",folded:!1}]},{name:"children2",folded:!1},{name:"children3",folded:!1}]},{name:"test2",folded:!1,id:"11",x:1,y:2}],foldedCache:{},bulbColor:"#bfbfbf",bulbClass:"",nailColor:"#bfbfbf",isWinTop:!1},watch:{treeData(e){}},methods:{getBulbColor(){let e="d4237a";return e=this.webSocket?"#1afa29":"#d4237a"},getNailClass(){return this.isWinTop?"nail-top":"nail-un-top"},onSetWinTop(){GoogleAnalytics.eventCustom("[main] 置顶功能"),this.isWinTop=!this.isWinTop,this.isWinTop?(this.nailColor="#d81e06",Editor.Ipc.sendToMain("cc-inspector:setWinTop",!0)):(this.nailColor="#bfbfbf",Editor.Ipc.sendToMain("cc-inspector:setWinTop",!1))},onBtnClickTest(){let e="db://assets/resources/cc-inspector.json";if(Editor.remote.assetdb.exists(e)){let t=Editor.assetdb.remote.urlToFspath(e),i=Fs.readFileSync(t,"utf-8");if(JSON.parse(i).isRunInGameStart)if(this.webSocket)GoogleAnalytics.eventCustom("[main] 刷新成功!"),this.webSocket.send(JSON.stringify({code:CCInspectorPluginMsg.Msg.GetTreeInfo,data:null}));else{GoogleAnalytics.eventCustom("[main] 刷新失败!"),0===Editor.Dialog.messageBox({type:"warning",title:"提示",buttons:["确定","取消"],message:"未发现有正在运行的游戏,请运行游戏后重试!\n点击确定,打开游戏预览面板.",defaultId:0,cancelId:1,noLink:!0})&&Editor.Panel.open("cc-inspector.preview-web")}else{0===Editor.Dialog.messageBox({type:"warning",title:"提示",buttons:["确定","取消"],message:"插件未设置自启动.\n点击确定打开设置面板,设置成功后刷新游戏即可!",defaultId:0,cancelId:1,noLink:!0})&&Editor.Panel.open("cc-inspector.set")}}else Editor.Dialog.messageBox({type:"error",title:"未知错误",buttons:["确定"],message:`未发现文件:${e}\n请联系插件开发作者!`,defaultId:0,cancelId:1,noLink:!0})},onBtnClickTestData(){this.onLaunchDebugServer()},onBtnClickOpenPreviewWeb(){Editor.Panel.open("cc-inspector.preview-web")},onBtnClickOpenTreeInfo(){Editor.Panel.open("cc-inspector.info")},_updateTreeInfo(){},onMsg(e){let t=JSON.parse(e),i=t.code,s=t.data;if(i===CCInspectorPluginMsg.Msg.GetTreeInfo){let e=[];for(let t=0;t<s.length;t++){let i=s[t];this.serialize(i,e)}this.treeData=e,Editor.Ipc.sendToPanel("cc-inspector.info","resetPanel")}else if(i===CCInspectorPluginMsg.Msg.GetNodeInfo){let e=this.serializeData(s);Editor.Ipc.sendToPanel("cc-inspector.info","onReceiveNodeInfo",e)}},_getPreIsFolded:e=>!0,serialize(e,t){let i=this.serializeData(e);for(let t=0;t<e.children.length;t++){let s=e.children[t];this.serialize(s,i.children)}t.push(i)},serializeComp(e){},serializeData(e){return{folded:this._getPreIsFolded(e.uuid),selected:!1,uuid:e.uuid,name:e.name,active:e.active,anchor:cc.v2(e.anchorX||0,e.anchorY||0),size:cc.size(e.width||0,e.height||0),position:cc.v2(e.x||0,e.y||0),scale:cc.v2(e.scaleX||0,e.scaleY||0),skew:cc.v2(e.skewX,e.skewY),opacity:e.opacity,rotation:e.rotation,color:{r:e.color.r,g:e.color.g,b:e.color.b,a:e.color.a},group:e.group,children:[],components:e.components}},_bulbOver(){this.bulbColor="#bfbfbf"},_bulbShake(){this.webSocket?this.bulbColor="#f4ea2a":this.bulbColor="#d4237a",this.bulbClass="bulb",setTimeout(()=>{this.bulbColor="#1afa29",this.bulbClass=""},1100)},probe(e,t){let i=require("net").createServer().listen(e);i.on("listening",()=>{i.once("close",()=>{t(!1,e)}),i.close()}),i.on("error",i=>{t(!0,e)})},_createDebugServer(e){this.wsServer&&this.wsServer.close(()=>{});let t=Editor.require("packages://cc-inspector/node_modules/ws");this.wsServer=new t.Server({port:e},()=>{Editor.log("[cc-inspector] 插件启动成功: "+e)}),this.wsServer.on("connection",e=>{this._bulbShake(),this.webSocket=e,e.on("message",e=>{this.onMsg(e)}),e.on("close",()=>{this.webSocket=null,this.treeData=[],Editor.Ipc.sendToPanel("cc-inspector.info","resetPanel"),this._bulbOver()}),e.on("error",()=>{this.webSocket=null,Editor.Ipc.sendToPanel("cc-inspector.info","resetPanel"),this.treeData=[],this._bulbOver()}),e.on("open",()=>{})})},_makeDir:async e=>await new Promise((t,i)=>{if(Editor.remote.assetdb.exists(e))return t(null),!0;Editor.assetdb.create(e,null,(e,s)=>e?(i(e),!1):(t(s),!0))}),_createFileWithData:async(e,t)=>await new Promise((i,s)=>{Editor.assetdb.createOrSave(e,t,(e,t)=>e?(s(e),!1):(i(t),!0))}),async _makeDirs(e){if(Editor.remote.assetdb.exists(e))return!0;this._makeDirs(Path.dirname(e))&&await this._makeDir(e);return!0},_onFindPort(e,t){if(e)this.probe(t+1,this._onFindPort.bind(this));else{let e=this._getLocalIp();(async()=>{let i="db://assets/resources/cc-inspector.json",s={host:e,port:t};if(Editor.remote.assetdb.exists(i)){let o=Editor.assetdb.remote.urlToFspath(i),n=Fs.readFileSync(o,"utf-8"),r=JSON.parse(n);r.host=e,r.port=t,s=r}else{let e=Path.dirname(i);await this._makeDirs(e)}await this._createFileWithData(i,JSON.stringify(s)),GoogleAnalytics.eventCustom(`[main] 调试服务器端口: ${t}`),this._createDebugServer(t)})()}},_getLocalIp(){let e="",t=require("os").networkInterfaces();return Object.keys(t).forEach(i=>{t[i].forEach(t=>{"IPv4"===t.family&&!1===t.internal&&(e=t.address)})}),e.length>0?e:"127.0.0.1"},onLaunchDebugServer(){this.probe(6543,this._onFindPort.bind(this))},updateNodeProperty(e){if(this.webSocket&&e&&void 0!==e.code&&e.data){let t=JSON.stringify(e);this.webSocket.send(t),e.code===CCInspectorPluginMsg.Msg.Active&&this.$root.$emit(PluginMsg.MsgInside.NodeActive,e.data)}}}})},messages:{onChangeProperty(e,t){this.plugin.updateNodeProperty(t)},"build-state-changed"(e,t,i,s,o){},"build-finished"(e,t){}}});